#!/bin/bash
# =============================================================================
# Set Cloud Build trigger substitution variables
# Uses export/import approach to update trigger substitutions
#
# Usage:
#   1. Copy this file to set-secrets.sh
#   2. Fill in your actual API keys
#   3. Run: ./scripts/set-secrets.sh
# =============================================================================

set -e

# Configuration
TRIGGER_NAME="${TRIGGER_NAME:-iitmdocs-rishav}"
REGION="${REGION:-asia-south1}"
PROJECT_ID=$(gcloud config get-value project 2>/dev/null)

echo "=== Setting Cloud Build Trigger Substitutions ==="
echo "Project: $PROJECT_ID"
echo "Trigger: $TRIGGER_NAME"
echo "Region: $REGION"
echo ""

# API Keys and Configuration - REPLACE WITH YOUR ACTUAL VALUES
_OPENAI_API_KEY="sk-proj-your-openai-api-key-here"
_GEMINI_API_KEY="your-gemini-api-key-here"
_CHAT_API_ENDPOINT="https://api.openai.com/v1/chat/completions"
_CHAT_MODEL="gpt-4o-mini"

# Optional: Cloud mode fallback (not needed for GCE mode)
_WEAVIATE_URL="https://your-cluster.weaviate.cloud"
_WEAVIATE_API_KEY="your-weaviate-api-key-here"
_COHERE_API_KEY="your-cohere-api-key-here"

# Export current trigger config
TEMP_FILE=$(mktemp)
echo "Exporting trigger configuration..."
gcloud beta builds triggers export "$TRIGGER_NAME" --region="$REGION" --destination="$TEMP_FILE"

# Update substitutions in the YAML file using sed
echo "Updating substitutions..."
# Remove existing substitutions section
sed -i '/^substitutions:/,/^[^ ]/{ /^substitutions:/d; /^  _/d; }' "$TEMP_FILE"

# Add new substitutions section at the end
cat >> "$TEMP_FILE" << EOF
substitutions:
  _OPENAI_API_KEY: $_OPENAI_API_KEY
  _GEMINI_API_KEY: $_GEMINI_API_KEY
  _CHAT_API_ENDPOINT: $_CHAT_API_ENDPOINT
  _CHAT_MODEL: $_CHAT_MODEL
  _WEAVIATE_URL: $_WEAVIATE_URL
  _WEAVIATE_API_KEY: $_WEAVIATE_API_KEY
  _COHERE_API_KEY: $_COHERE_API_KEY
EOF

# Import updated trigger config
echo "Importing updated trigger configuration..."
gcloud beta builds triggers import --region="$REGION" --source="$TEMP_FILE"

# Cleanup
rm -f "$TEMP_FILE"

echo ""
echo "=== Done! ==="
echo "Cloud Build trigger '$TRIGGER_NAME' has been updated with the API keys."
echo ""
echo "Note: GCE_WEAVIATE_URL and GCE_OLLAMA_URL are automatically set during build"
echo "from the GCE VM static IP - no manual configuration needed."
